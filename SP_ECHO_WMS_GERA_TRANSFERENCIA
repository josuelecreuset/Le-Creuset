 CREATE OR ALTER PROCEDURE DBO.SP_ECHO_WMS_GERA_TRANSFERENCIA(@ID BIGINT, @EXIBE_PRINT BIT = 0, @RETORNA_STATUS BIT = 0 )
AS
BEGIN 
	SET NOCOUNT ON

	--> Declaracao de variaveis
	DECLARE @WMS_FAT_COD_TRANSACAO		VARCHAR(23),
			@WMS_FAT_NATUREZA			VARCHAR(7),
			@WMS_FAT_TAB_FILHA			VARCHAR(18),
			@WMS_FAT_TIPO_FRETE			VARCHAR(50),
			@WMS_FAT_TIPO_VOLUME		VARCHAR(35),
			@WMS_FAT_TRANSPORTADORA		VARCHAR(25),
			@WMS_FAT_TRANSPORTADORA_RE	VARCHAR(25),
			@WMS_FAT_SERIE				VARCHAR(6),
			@WMS_FAT_AGRUPAMENTO		VARCHAR(2),
			@NATUREZA_SAIDA				VARCHAR(10),
			@EMISSAO					DATETIME,
			@VALOR_TOTAL				NUMERIC(14,2),
			@DESCONTO_TOTAL				NUMERIC(14,2),
			@QTDE_TOTAL					INT,
			@NF_SAIDA					VARCHAR(15),
			@FILIAL						VARCHAR(25),
			@CNPJ						VARCHAR(14),
			@CIDADE						VARCHAR(35),
			@UF							VARCHAR(20),
			@AAMM						VARCHAR(4),
			@MODELO						VARCHAR(2),
			@TIPO_EMISSAO				INT	,
			@VERSAO_CHAVE_NFE			VARCHAR(6),
			@WMS_FAT_RATEIO_FILIAL		VARCHAR(6),
			@WMS_FAT_RATEIO_CC			VARCHAR(25),
			@CHAVE_NFE					VARCHAR(44),
			@ID_CONTROLE				BIGINT,
			@STEP						INT = 0,
			@NOME_CLIFOR				VARCHAR(25),
			@STATUS_CONCLUSAO			INT,
			@MSG_CONCLUSAO				VARCHAR(254),
			@FILIAL_ESTOQUE				VARCHAR(25),
			@NATUREZA_TRANSF			VARCHAR(25),
			@PEDIDO						VARCHAR(15),
			@WMS_TRANSF_TRANSPORTADORA	VARCHAR(25),
			@NF_SAIDA_ORIGEM			VARCHAR(15),
			@SERIE_SAIDA_ORIGEM			VARCHAR(10),
			@NF_TRANSF					VARCHAR(15)

	DECLARE @CHAVE_NFE_T TABLE (CHAVE VARCHAR(44))

	--> Alimenta valores das variaveis com Parametros
	SELECT @WMS_FAT_COD_TRANSACAO		= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_COD_TRANSACAO'
	SELECT @WMS_FAT_NATUREZA			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_NATUREZA'
	SELECT @WMS_FAT_TAB_FILHA			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_TAB_FILHA'
	SELECT @WMS_FAT_TIPO_FRETE			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_TIPO_FRETE'
	SELECT @WMS_FAT_TIPO_VOLUME			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_TIPO_VOLUME'
	SELECT @WMS_FAT_TRANSPORTADORA		= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_TRANSPORTADORA'
	SELECT @WMS_FAT_TRANSPORTADORA_RE	= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_TRANSPORTADORA_RE'
	SELECT @WMS_FAT_SERIE				= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_SERIE'
	SELECT @WMS_FAT_AGRUPAMENTO			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_AGRUPAMENTO'

	SELECT @WMS_FAT_RATEIO_FILIAL		= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_RATEIO_FILIAL'
	SELECT @WMS_FAT_RATEIO_CC			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FAT_RATEIO_CC'

	SELECT @TIPO_EMISSAO				= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'IDENTIFICA_AMBIENTE_NFE'
	SELECT @VERSAO_CHAVE_NFE			= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'VERSAO_LAYOUT_XML_NFE'  
	SELECT @FILIAL_ESTOQUE				= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_FILIAL_ESTOQUE_ECOM'  
	SELECT @NATUREZA_TRANSF				= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_TRANSF_NATUREZA'  
	SELECT @WMS_TRANSF_TRANSPORTADORA	= VALOR_ATUAL FROM PARAMETROS WITH(NOLOCK) WHERE PARAMETRO = 'WMS_TRANSF_TRANSPORTADORA'  

	-- Tratamento Campos Rateio
	IF @WMS_FAT_RATEIO_FILIAL = ''
		SET @WMS_FAT_RATEIO_FILIAL = NULL

	IF @WMS_FAT_RATEIO_CC = ''
		SET @WMS_FAT_RATEIO_CC = NULL

	-- Se existir, Drop tabelas Temporarias
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO') IS NOT NULL				DROP TABLE #TMP_FATURAMENTO
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO_PROD') IS NOT NULL		DROP TABLE #TMP_FATURAMENTO_PROD
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO_ITEM') IS NOT NULL		DROP TABLE #TMP_FATURAMENTO_ITEM
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO_IMPOSTO') IS NOT NULL		DROP TABLE #TMP_FATURAMENTO_IMPOSTO

	--> Cria tabelas Temporarias
	SELECT 
		FILIAL, -- FILIAL EMISSORA
		NF_SAIDA, -- NUMERO DA NF
		SERIE_NF, -- SERIE DA NF
		NOME_CLIFOR, -- DESTINO
		CONDICAO_PGTO, -- 
		NATUREZA_SAIDA,
		TRANSPORTADORA,
		TRANSP_REDESPACHO,
		TIPO_FRETE,
		COD_TRANSACAO,
		EMISSAO,
		DATA_SAIDA,
		FRETE,
		SEGURO,
		DESCONTO,
		DESCONTO_COND_PGTO,
		ENCARGO,
		ICMS,
		IPI_VALOR,
		VALOR_TOTAL,
		QTDE_TOTAL,
		NF_FATURA,
		FATURA,
		NOTA_IMPRESSA,
		ACERTO_CONTAS_P_R,
		TABELA_FILHA,
		OBS,
		PESO_LIQUIDO,
		PESO_BRUTO,
		VOLUMES,
		TIPO_VOLUME,
		CONFERIDO,
		CONFERIDO_POR,
		ENTREGA_CIF,
		IRRF,
		IRRF_RET_FONTE,
		NOTA_CANCELADA,
		DEVOLUCAO,
		REPRESENTANTE,
		COMISSAO,
		PORCENTAGEM_ACERTO,
		GERENTE,
		COMISSAO_GERENTE,
		DESCONTO_BRUTO,
		ICMS_BASE,
		VALOR_CANCELADO,
		QTDE_CANCELADA,
		MOEDA,
		CAMBIO_NA_DATA,
		COBRAR_MOEDA_PADRAO,
		RECARGO,
		DATA_PARA_TRANSFERENCIA,
		NOME_CLIFOR_ENTREGA,
		VALOR_FRETE,
		OBS_TRANSPORTE,
		AGRUPAMENTO_ITENS,
		COMISSAO_VALOR,
		COMISSAO_VALOR_GERENTE,
		CTB_ITEM,
		CTB_LANCAMENTO,
		DESCONTO_BRUTO_1,
		DESCONTO_BRUTO_2,
		DESCONTO_BRUTO_3,
		DESCONTO_BRUTO_4,
		DESCONTO_SOBRE_1,
		DESCONTO_SOBRE_2,
		DESCONTO_SOBRE_3,
		DESCONTO_SOBRE_4,
		EMPRESA,
		FATURA_FILIAL,
		FATURA_NUMERO,
		FATURA_SERIE,
		ICMS_ISENTO,
		ICMS_OUTROS,
		MPADRAO_DESCONTO,
		MPADRAO_DESCONTO_COND_PGTO,
		MPADRAO_ENCARGO,
		MPADRAO_FRETE,
		MPADRAO_IMPOSTO_AGREGAR,
		MPADRAO_SEGURO,
		MPADRAO_VALOR_SUB_ITENS,
		MPADRAO_VALOR_TOTAL,
		MULTI_DESCONTO_ACUMULAR,
		PORC_DESCONTO,
		PORC_DESCONTO_BRUTO,
		PORC_DESCONTO_COND_PGTO,
		PORC_DESCONTO_DIGITADO,
		PORC_ENCARGO,
		RATEIO_CENTRO_CUSTO,
		RATEIO_FILIAL,
		VALOR_DIFERENCA_GUIA_FATURA,
		VALOR_IMPOSTO_AGREGAR,
		VALOR_SUB_ITENS,
		IMPRIMIR_ENDERECO_COBRANCA,
		INDICA_CONSUMIDOR_FINAL,
		NOTA_COMPLEMENTAR,
		PORC_DESCONTO_SEFAZ,
		DESCONTO_SEFAZ,
		MPADRAO_DESCONTO_SEFAZ,
		CHAVE_NFE,
		GERAR_AUTOMATICO,
		STATUS_NFE,
		LOG_STATUS_NFE,
		ITEM_NFE,
		PRIORIZACAO,
		REGISTRO_DPEC,
		DATA_REGISTRO_DPEC,
		TIPO_EMISSAO_NFE,
		FIN_EMISSAO_NFE,
		VALOR_DESPACHO,
		VALOR_IMPOSTO_INCIDENCIA,
		MPADRAO_VALOR_IMPOSTO_INCIDENCIA,
		DATA_HORA_EMISSAO,
		INDICA_PRESENCA_COMPRADOR,
		UTC_DATA_SAIDA,
		UTC_EMISSAO,
		INDICA_ENDERECO_ENTREGA,
		INFO_PGTO,
		DESC_MEIO_PGTO
	INTO #TMP_FATURAMENTO
	FROM DBO.FATURAMENTO WITH(NOLOCK) 
	WHERE 1 = 0

	SELECT 
		FILIAL,
		NF_SAIDA,
		SERIE_NF,
		PRODUTO,
		COR_PRODUTO,
		ITEM,
		PEDIDO,
		PEDIDO_PRODUTO,
		PEDIDO_COR,
		ENTREGA,
		CAIXA,
		ROMANEIO,
		IPI,
		ICMS,
		DESCONTO_ITEM,
		QTDE,
		PRECO,
		VALOR,
		MATA_SALDO,
		F1,
		F2,
		F3,
		F4,
		F5,
		F6,
		F7,
		F8,
		F9,
		F10,
		F11,
		F12,
		F13,
		F14,
		F15,
		F16,
		F17,
		F18,
		F19,
		F20,
		F21,
		F22,
		F23,
		F24,
		F25,
		F26,
		F27,
		F28,
		F29,
		F30,
		F31,
		F32,
		F33,
		F34,
		F35,
		F36,
		F37,
		F38,
		F39,
		F40,
		F41,
		F42,
		F43,
		F44,
		F45,
		F46,
		F47,
		F48,
		FAIXA,
		ORIGEM,
		CUSTO_NA_DATA,
		MOEDA,
		CAMBIO_NA_DATA,
		ORIGEM_EMB,
		DATA_PARA_TRANSFERENCIA,
		CODIGO_LOCAL_ENTREGA,
		CODIGO_FISCAL_OPERACAO,
		COD_FILIAL_ESTOQUE,
		CUSTO_NA_DATA_2,
		CUSTO_NA_DATA_3,
		CUSTO_NA_DATA_4,
		ITEM_IMPRESSAO,
		ITEM_IMPRESSAO_FATURA,
		ITEM_PEDIDO,
		PRECO_2,
		PRECO_3,
		PRECO_4,
		VALOR_DIFERENCA_GUIA_FATURA_ITEM,
		DESC_VENDA_CLIENTE,
		LICENCIADO_ROYALTIES
	INTO #TMP_FATURAMENTO_PROD
	FROM FATURAMENTO_PROD WITH(NOLOCK)
	WHERE 1 = 0

	SELECT 
		CLASSIF_FISCAL,
		CODIGO_FISCAL_OPERACAO,
		CODIGO_ITEM,
		COD_TABELA_FILHA,
		COMISSAO_ITEM,
		COMISSAO_ITEM_GERENTE,
		CONTA_CONTABIL,
		DESCONTO_ITEM,
		DESCRICAO_ITEM,
		FAIXA,
		FILIAL,
		ID_EXCECAO_IMPOSTO,
		INDICADOR_CFOP,
		ITEM_IMPRESSAO,
		MPADRAO_DESCONTO_ITEM,
		MPADRAO_PRECO_UNITARIO,
		MPADRAO_VALOR_ITEM,
		NF_SAIDA,
		PESO,
		PORCENTAGEM_ITEM_RATEIO,
		PRECO_UNITARIO,
		QTDE_DEVOLVIDA,
		QTDE_ITEM,
		QTDE_RETORNAR_BENEFICIAMENTO,
		SERIE_NF,
		SUB_ITEM_TAMANHO,
		TRIBUT_ICMS,
		TRIBUT_ORIGEM,
		UNIDADE,
		VALOR_ITEM,
		REFERENCIA,
		REFERENCIA_ITEM,
		MPADRAO_VALOR_DESCONTOS,
		MPADRAO_VALOR_ENCARGOS,
		NAO_SOMA_VALOR,
		ITEM_NFE,
		MPADRAO_SEGURO_ITEM,
		MPADRAO_FRETE_ITEM,
		MPADRAO_ENCARGO_ITEM,
		ORIGEM_ITEM,
		VALOR_IMPOSTO_ITEM,
		INDICA_PRODUTO_PROCESSO,
		PRECO_UNITARIO_ORIGINAL,
		VALOR_IMPOSTO_ITEM_MUNICIPAL,
		VALOR_IMPOSTO_ITEM_ESTADUAL 
	INTO #TMP_FATURAMENTO_ITEM
	FROM DBO.FATURAMENTO_ITEM WITH(NOLOCK) 
	WHERE 1 = 0

	SELECT 
		AGREGA_APOS_DESCONTO,
		AGREGA_APOS_ENCARGO,
		BASE_IMPOSTO,
		FILIAL,
		ID_IMPOSTO,
		INCIDENCIA,
		ITEM_IMPRESSAO,
		NF_SAIDA,
		SERIE_NF,
		SUB_ITEM_TAMANHO,
		TAXA_IMPOSTO,
		VALOR_IMPOSTO,
		VALOR_IMPOSTO_CALCULADO,
		BASE_IMPOSTO_CALC
	INTO #TMP_FATURAMENTO_IMPOSTO
	FROM DBO.FATURAMENTO_IMPOSTO WITH(NOLOCK)
	WHERE 1 = 0

	SELECT	@NOME_CLIFOR			= CLIENTE, 
			@PEDIDO					= CHAVE, 
			@FILIAL					= FILIAL ,
			@NF_SAIDA_ORIGEM		= SAIDA_NF,
			@SERIE_SAIDA_ORIGEM		= SAIDA_SERIE,
			@NF_TRANSF				= TRANSF_NF
	FROM DBO.TB_ECHO_WMS_CONTROLE WITH(NOLOCK)
	WHERE ID = @ID

	IF ISNULL(@NF_TRANSF,'')  = '' AND ISNULL((SELECT VALOR_PROPRIEDADE FROM DBO.PROP_FILIAIS WITH(NOLOCK) WHERE PROPRIEDADE = 'WMS05' AND FILIAL = @FILIAL),'NAO') = 'SIM'
	BEGIN
		--> Insere dado nas tabelas temporarias
		INSERT INTO #TMP_FATURAMENTO
		SELECT TOP 1
			FILIAL							= @FILIAL_ESTOQUE, -- FILIAL EMISSORA
			NF_SAIDA						= '', -- NUMERO DA NF
			SERIE_NF						= @WMS_FAT_SERIE , -- SERIE DA NF
			NOME_CLIFOR						= @FILIAL, -- DESTINO
			CONDICAO_PGTO					= '001', 
			NATUREZA_SAIDA					= @NATUREZA_TRANSF,
			TRANSPORTADORA					= @WMS_TRANSF_TRANSPORTADORA,
			TRANSP_REDESPACHO				= @WMS_TRANSF_TRANSPORTADORA,
			TIPO_FRETE						= '01',
			COD_TRANSACAO					= @WMS_FAT_COD_TRANSACAO,
			EMISSAO							= CONVERT(DATE, GETDATE()),
			DATA_SAIDA						= CONVERT(DATE, GETDATE()),
			FRETE							= 0.00, --  TRIGGER IRA CALCULAR DEPOIS
			SEGURO							= 0.00, 
			DESCONTO						= 0.00, -- ATUALIZAR DEPOIS
			DESCONTO_COND_PGTO				= 0.00, -- ATUALIZAR DEPOIS
			ENCARGO							= 0.00, -- FIXO 0
			ICMS							= 0.00,
			IPI_VALOR						= 0.00,
			VALOR_TOTAL						= 0.00, -- ATUALIZAR DEPOIS
			QTDE_TOTAL						= 0.00, -- ATUALIZAR DEPOIS
			NF_FATURA						= '', -- NUMERO DA NOTA
			FATURA							= 1,
			NOTA_IMPRESSA					= 0 ,
			ACERTO_CONTAS_P_R				= 0 ,
			TABELA_FILHA					= @WMS_FAT_TAB_FILHA,
			OBS								= 'Pedido '+RTRIM(LTRIM(@PEDIDO)), -- REVER FORMATO DA OBSERVACAO
			PESO_LIQUIDO					= 0.00, -- REVER SE SERÁ NECESSÁRIO COLOCAR PESO
			PESO_BRUTO						= 0.00, -- REVER SE SERÁ NECESSÁRIO COLOCAR PESO
			VOLUMES							= 1, -- REVER SE SERA NECESSARIO
			TIPO_VOLUME						= @WMS_FAT_TIPO_VOLUME,
			CONFERIDO						= 0,
			CONFERIDO_POR					= '',
			ENTREGA_CIF						= 1,
			IRRF							= 0.00,
			IRRF_RET_FONTE					= 0,
			NOTA_CANCELADA					= 0,
			DEVOLUCAO						= 0,
			REPRESENTANTE					= NULL,
			COMISSAO						= 0.00, -- FIXO 0.00
			PORCENTAGEM_ACERTO				= 0.00,
			GERENTE							= NULL,
			COMISSAO_GERENTE				= 0.00 , -- FIXO 0.00
			DESCONTO_BRUTO					= 0.00,  -- FIXO 0.00
			ICMS_BASE						= 0.00,
			VALOR_CANCELADO					= 0,
			QTDE_CANCELADA					= 0 ,
			MOEDA							= 'R$',
			CAMBIO_NA_DATA					= 1 ,
			COBRAR_MOEDA_PADRAO				= 1 ,
			RECARGO							= 0, -- FIXO 0
			DATA_PARA_TRANSFERENCIA			= GETDATE(),
			NOME_CLIFOR_ENTREGA				= @FILIAL,
			VALOR_FRETE						= 0.00,
			OBS_TRANSPORTE					= '', --REVER O QUE INFORMAR
			AGRUPAMENTO_ITENS				= @WMS_FAT_AGRUPAMENTO,
			COMISSAO_VALOR					= 0.00,  -- FIXO 0.00
			COMISSAO_VALOR_GERENTE			= 0.00,  -- FIXO 0.00
			CTB_ITEM						= NULL,
			CTB_LANCAMENTO					= NULL,
			DESCONTO_BRUTO_1				= 0.00,  -- FIXO 0.00,
			DESCONTO_BRUTO_2				= 0.00,  -- FIXO 0.00,
			DESCONTO_BRUTO_3				= 0.00,  -- FIXO 0.00,
			DESCONTO_BRUTO_4				= 0.00,  -- FIXO 0.00,
			DESCONTO_SOBRE_1				= 0.00,  -- FIXO 0.00,
			DESCONTO_SOBRE_2				= 0.00,  -- FIXO 0.00,
			DESCONTO_SOBRE_3				= 0.00,  -- FIXO 0.00,
			DESCONTO_SOBRE_4				= 0.00,  -- FIXO 0.00,
			EMPRESA							= 1,
			FATURA_FILIAL					= @FILIAL_ESTOQUE,
			FATURA_NUMERO					= '', -- REVER NUMERO DA NF
			FATURA_SERIE					= @WMS_FAT_SERIE,
			ICMS_ISENTO						= 0,
			ICMS_OUTROS						= 0,
			MPADRAO_DESCONTO				= 0.00, -- ATUALIZAR DEPOIS
			MPADRAO_DESCONTO_COND_PGTO		= 0.00, -- ATUALIZAR DEPOIS
			MPADRAO_ENCARGO					= 0.00, -- ATUALIZAR DEPOIS
			MPADRAO_FRETE					= 0.00, -- ATUALIZAR DEPOIS
			MPADRAO_IMPOSTO_AGREGAR			= 0.00,
			MPADRAO_SEGURO					= 0.00, -- ATUALIZAR DEPOIS
			MPADRAO_VALOR_SUB_ITENS			= 0.00, -- ATUALIZAR DEPOIS
			MPADRAO_VALOR_TOTAL				= 0.00, -- ATUALIZAR DEPOIS
			MULTI_DESCONTO_ACUMULAR			= 0.00, -- FIXO
			PORC_DESCONTO					= 0.00, -- FIXO
			PORC_DESCONTO_BRUTO				= 0.00, -- FIXO
			PORC_DESCONTO_COND_PGTO			= 0.00, -- FIXO
			PORC_DESCONTO_DIGITADO			= 0.00, -- FIXO
			PORC_ENCARGO					= 0.00,
			RATEIO_CENTRO_CUSTO				= @WMS_FAT_RATEIO_CC, 
			RATEIO_FILIAL					= @WMS_FAT_RATEIO_FILIAL, 
			VALOR_DIFERENCA_GUIA_FATURA		= 0, 
			VALOR_IMPOSTO_AGREGAR			= 0,
			VALOR_SUB_ITENS					= 0.00, -- ATUALIZAR DEPOIS
			IMPRIMIR_ENDERECO_COBRANCA		= 0,
			INDICA_CONSUMIDOR_FINAL			= 0,
			NOTA_COMPLEMENTAR				= 0 ,
			PORC_DESCONTO_SEFAZ				= 0 ,
			DESCONTO_SEFAZ					= 0,
			MPADRAO_DESCONTO_SEFAZ			= 0,
			CHAVE_NFE						= NULL, -- ATUALIZAR DEPOIS
			GERAR_AUTOMATICO				= 0 ,
			STATUS_NFE						= 0 ,
			LOG_STATUS_NFE					= NULL,
			ITEM_NFE						= NULL,
			PRIORIZACAO						= 0 ,
			REGISTRO_DPEC					= NULL,
			DATA_REGISTRO_DPEC				= NULL,
			TIPO_EMISSAO_NFE				= NULL,
			FIN_EMISSAO_NFE					= NULL,
			VALOR_DESPACHO					= NULL,
			VALOR_IMPOSTO_INCIDENCIA		= NULL,
			MPADRAO_VALOR_IMPOSTO_INCIDENCIA= NULL,
			DATA_HORA_EMISSAO				= NULL,
			INDICA_PRESENCA_COMPRADOR		= 0,
			UTC_DATA_SAIDA					= NULL,
			UTC_EMISSAO						= NULL,
			INDICA_ENDERECO_ENTREGA			= NULL,
			INFO_PGTO						= NULL,
			DESC_MEIO_PGTO					= NULL

		--> Obtem dados complementares
		SELECT	@NATUREZA_SAIDA = NATUREZA_SAIDA, 
				@EMISSAO = EMISSAO, 
				@NOME_CLIFOR = NOME_CLIFOR 
		FROM #TMP_FATURAMENTO

		SELECT 
			@CNPJ	= CGC_CPF,
			@UF		= UF,
			@CIDADE = CIDADE,
			@AAMM	= RTRIM(LTRIM(RIGHT(CONVERT(VARCHAR(4),YEAR(@EMISSAO)),2)))+ RTRIM(LTRIM(RIGHT('00'+RTRIM(LTRIM(CONVERT(VARCHAR(2),MONTH(@EMISSAO)))),2)))
		FROM DBO.CADASTRO_CLI_FOR WITH(NOLOCK)
		WHERE NOME_CLIFOR =  @FILIAL_ESTOQUE

		--> Insere dados nas tabelas temporarias
		INSERT INTO #TMP_FATURAMENTO_PROD
		SELECT 
			FILIAL								= @FILIAL_ESTOQUE,
			NF_SAIDA							= '',
			SERIE_NF							= @WMS_FAT_SERIE,
			PRODUTO								= A.PRODUTO,
			COR_PRODUTO							= A.COR_PRODUTO,
			ITEM								= A.ITEM,
			PEDIDO								= NULL,
			PEDIDO_PRODUTO						= NULL,
			PEDIDO_COR							= NULL,
			ENTREGA								= NULL,
			CAIXA								= NULL,
			ROMANEIO							= NULL,
			IPI									= A.IPI,
			ICMS								= 0,
			DESCONTO_ITEM						= A.DESCONTO_ITEM,
			QTDE								= A.QTDE,
			PRECO								= A.PRECO,
			VALOR								= A.VALOR,	
			MATA_SALDO							= A.MATA_SALDO,
			F1									= F1,
			F2									= F2,
			F3									= F3,
			F4									= F4,
			F5									= F5,
			F6									= F6,
			F7									= F7,
			F8									= F8,
			F9									= F9,
			F10									= F10,
			F11									= F11,
			F12									= F12,
			F13									= F13,
			F14									= F14,
			F15									= F15,
			F16									= F16,
			F17									= F17,
			F18									= F18,
			F19									= F19,
			F20									= F20,
			F21									= F21,
			F22									= F22,
			F23									= F23,
			F24									= F24,
			F25									= F25,
			F26									= F26,
			F27									= F27,
			F28									= F28,
			F29									= F29,
			F30									= F30,
			F31									= F31,
			F32									= F32,
			F33									= F33,
			F34									= F34,
			F35									= F35,
			F36									= F36,
			F37									= F37,
			F38									= F38,
			F39									= F39,
			F40									= F40,
			F41									= F41,
			F42									= F42,
			F43									= F43,
			F44									= F44,
			F45									= F45,
			F46									= F46,
			F47									= F47,
			F48									= F48,
			FAIXA								= 1,
			ORIGEM								= 'E',  -- FIXO
			CUSTO_NA_DATA						= 0.00, -- FIXO 0.00
			MOEDA								= '',
			CAMBIO_NA_DATA						= 1,
			ORIGEM_EMB							= 'V',
			DATA_PARA_TRANSFERENCIA				= GETDATE(),
			CODIGO_LOCAL_ENTREGA				= '', -- FIXO
			CODIGO_FISCAL_OPERACAO				= CASE WHEN CLI.UF = 'EX' THEN CCC.CODIGO_FISCAL_EXTERIOR ELSE CASE WHEN FI.UF = CLI.UF THEN CCC.CODIGO_FISCAL_OPERACAO ELSE CCC.CODIGO_FISCAL_INTERESTADUAL END END , -- REVER ORIGEM,
			COD_FILIAL_ESTOQUE					= C.COD_FILIAL, 
			CUSTO_NA_DATA_2						= 0.00,
			CUSTO_NA_DATA_3						= 0.00,
			CUSTO_NA_DATA_4						= 0.00,
			ITEM_IMPRESSAO						= A.ITEM_IMPRESSAO,
			ITEM_IMPRESSAO_FATURA				= '',
			ITEM_PEDIDO							= '',
			PRECO_2								= A.PRECO_2,
			PRECO_3								= A.PRECO_3,
			PRECO_4								= A.PRECO_4,
			VALOR_DIFERENCA_GUIA_FATURA_ITEM	= 0,
			DESC_VENDA_CLIENTE					= '',
			LICENCIADO_ROYALTIES				= 0 
		FROM DBO.FATURAMENTO_PROD A WITH(NOLOCK)
		JOIN DBO.FILIAIS C WITH(NOLOCK) ON
			@FILIAL_ESTOQUE = C.FILIAL
		JOIN DBO.CADASTRO_CLI_FOR FI WITH(NOLOCK) ON
			C.CLIFOR = FI.CLIFOR
		JOIN DBO.CADASTRO_CLI_FOR CLI WITH(NOLOCK) ON
			@FILIAL = CLI.NOME_CLIFOR
		JOIN DBO.PRODUTOS P WITH(NOLOCK) ON
			A.PRODUTO = P.PRODUTO
		JOIN DBO.NATUREZAS_SAIDAS NS WITH(NOLOCK) ON
			NS.NATUREZA_SAIDA = @NATUREZA_TRANSF
		JOIN DBO.CTB_LX_CARACTERISTICA_CFOP CCC WITH(NOLOCK) ON
			CCC.CTB_TIPO_OPERACAO = NS.CTB_TIPO_OPERACAO AND
			CCC.INDICADOR_CFOP = P.INDICADOR_CFOP AND
			CCC.INDICADOR_FISCAL_TERCEIRO = CLI.INDICADOR_FISCAL_TERCEIRO AND
			CCC.INATIVO = 0
		WHERE A.FILIAL = @FILIAL AND A.NF_SAIDA = @NF_SAIDA_ORIGEM AND A.SERIE_NF = @SERIE_SAIDA_ORIGEM

		--Obtem Totais a partir dos itens
		SELECT 
			@VALOR_TOTAL = SUM(VALOR),
			@QTDE_TOTAL	 = SUM(QTDE)
		FROM #TMP_FATURAMENTO_PROD

		INSERT INTO #TMP_FATURAMENTO_ITEM
		SELECT
			CLASSIF_FISCAL						= A.CLASSIF_FISCAL,
			CODIGO_FISCAL_OPERACAO				= CASE WHEN CLI.UF = 'EX' THEN CCC.CODIGO_FISCAL_EXTERIOR ELSE CASE WHEN FI.UF = CLI.UF THEN CCC.CODIGO_FISCAL_OPERACAO ELSE CCC.CODIGO_FISCAL_INTERESTADUAL END END, -- REVER
			CODIGO_ITEM							= A.CODIGO_ITEM, -- REVER COMO COMPOR ESTE CODIGO
			COD_TABELA_FILHA					= 'P',
			COMISSAO_ITEM						= 0.00,
			COMISSAO_ITEM_GERENTE				= 0.00,
			CONTA_CONTABIL						= P.CONTA_CONTABIL, -- REVER
			DESCONTO_ITEM						= A.DESCONTO_ITEM,
			DESCRICAO_ITEM						= A.DESCRICAO_ITEM,
			FAIXA								= 1,
			FILIAL								= @FILIAL_ESTOQUE,
			ID_EXCECAO_IMPOSTO					= dbo.fx_id_excecao_imposto(
																			CCC.CTB_TIPO_OPERACAO,
																			CLI.CLIFOR,
																			A.INDICADOR_CFOP,
																			'S',
																			C.MATRIZ_FISCAL,
																			A.FILIAL,
																			@EMISSAO,
																			A.TRIBUT_ORIGEM,
																			CASE WHEN CLI.UF = 'EX' THEN CCC.CODIGO_FISCAL_EXTERIOR ELSE CASE WHEN FI.UF = CLI.UF THEN CCC.CODIGO_FISCAL_OPERACAO ELSE CCC.CODIGO_FISCAL_INTERESTADUAL END END,
																			A.REFERENCIA,
																			@FILIAL,
																			'P',
																			@NATUREZA_TRANSF,
																			C.COD_FILIAL), -- PEGAR EXCECAO
			INDICADOR_CFOP						= A.INDICADOR_CFOP,
			ITEM_IMPRESSAO						= A.ITEM_IMPRESSAO,
			MPADRAO_DESCONTO_ITEM				= A.DESCONTO_ITEM,
			MPADRAO_PRECO_UNITARIO				= A.MPADRAO_PRECO_UNITARIO, 
			MPADRAO_VALOR_ITEM					= A.MPADRAO_VALOR_ITEM,
			NF_SAIDA							= '',
			PESO								= 0.00,
			PORCENTAGEM_ITEM_RATEIO				= A.PORCENTAGEM_ITEM_RATEIO,
			PRECO_UNITARIO						= A.PRECO_UNITARIO,
			QTDE_DEVOLVIDA						= 0 ,
			QTDE_ITEM							= A.QTDE_ITEM,
			QTDE_RETORNAR_BENEFICIAMENTO		= 0,
			SERIE_NF							= @WMS_FAT_SERIE,
			SUB_ITEM_TAMANHO					= 1,
			TRIBUT_ICMS							= A.TRIBUT_ICMS,
			TRIBUT_ORIGEM						= A.TRIBUT_ORIGEM,
			UNIDADE								= A.UNIDADE,
			VALOR_ITEM							= A.VALOR_ITEM,
			REFERENCIA							= A.REFERENCIA,
			REFERENCIA_ITEM						= RTRIM(LTRIM(REFERENCIA_ITEM)),
			MPADRAO_VALOR_DESCONTOS				= 0.00, -- FIXO
			MPADRAO_VALOR_ENCARGOS				= 0.00, -- FIXO,
			NAO_SOMA_VALOR						= 0,
			ITEM_NFE							= A.ITEM_NFE,
			MPADRAO_SEGURO_ITEM					= 0.00, -- FIXO,
			MPADRAO_FRETE_ITEM					= 0.00, -- FIXO,
			MPADRAO_ENCARGO_ITEM				= 0.00, -- FIXO,
			ORIGEM_ITEM							= 'P',   -- FIXO,
			VALOR_IMPOSTO_ITEM					= 0.00, -- FIXO,
			INDICA_PRODUTO_PROCESSO				= 0.00, -- FIXO,
			PRECO_UNITARIO_ORIGINAL				= 0.00, -- FIXO,
			VALOR_IMPOSTO_ITEM_MUNICIPAL		= 0.00, -- FIXO,
			VALOR_IMPOSTO_ITEM_ESTADUAL			= 0.00  -- FIXO, 
		FROM DBO.FATURAMENTO_ITEM A
		JOIN DBO.FILIAIS C WITH(NOLOCK) ON
			@FILIAL_ESTOQUE = C.FILIAL
		JOIN DBO.CADASTRO_CLI_FOR FI WITH(NOLOCK) ON
			C.CLIFOR = FI.CLIFOR
		JOIN DBO.CADASTRO_CLI_FOR CLI WITH(NOLOCK) ON
			@FILIAL = CLI.NOME_CLIFOR
		JOIN DBO.NATUREZAS_SAIDAS NS WITH(NOLOCK) ON
			NS.NATUREZA_SAIDA = @NATUREZA_TRANSF
		JOIN DBO.CTB_LX_CARACTERISTICA_CFOP CCC WITH(NOLOCK) ON
			CCC.CTB_TIPO_OPERACAO = NS.CTB_TIPO_OPERACAO AND
			CCC.INDICADOR_CFOP = A.INDICADOR_CFOP AND
			CCC.INDICADOR_FISCAL_TERCEIRO = CLI.INDICADOR_FISCAL_TERCEIRO AND
			CCC.INATIVO = 0
		JOIN DBO.PRODUTOS P WITH(NOLOCK) ON
			A.REFERENCIA = P.PRODUTO
		WHERE A.FILIAL = @FILIAL AND A.NF_SAIDA = @NF_SAIDA_ORIGEM AND A.SERIE_NF = @SERIE_SAIDA_ORIGEM

		IF (SELECT COUNT(*) FROM #TMP_FATURAMENTO_PROD) > 0 
		BEGIN
		


			SET @STEP = 1
			--> Atualiza totais na capa
			UPDATE #TMP_FATURAMENTO
				SET 	
				DESCONTO						= ISNULL(@DESCONTO_TOTAL,0.00), 
				VALOR_TOTAL						= @VALOR_TOTAL, 
				QTDE_TOTAL						= @QTDE_TOTAL, 
				MPADRAO_DESCONTO				= ISNULL(@DESCONTO_TOTAL,0.00), 
				MPADRAO_VALOR_SUB_ITENS			= @VALOR_TOTAL, 
				MPADRAO_VALOR_TOTAL				= @VALOR_TOTAL 

			SET @STEP = 2
			--> Obtem Sequencial da Nota Fiscal
			EXEC DBO.SP_ECHO_SEQUENCIA_NF @WMS_FAT_SERIE ,@FILIAL_ESTOQUE, @NF_SAIDA OUT

			SET @STEP = 3
			--> Gera Chave NFe
			INSERT INTO @CHAVE_NFE_T
			EXEC LX_GERA_CHAVE_NFE_GENERICA 
				@NOTAFISCAL			= @NF_SAIDA,
				@SERIENOTA			= @WMS_FAT_SERIE,
				@CNPJ_EMITENTE		= @CNPJ,
				@CIDADE_EMITENTE	= @CIDADE,
				@UF_EMITENTE		= @UF,
				@AAMM_EMISSAO		= @AAMM,
				@MODELO				= '55',
				@TIPO_EMISSAO		= @TIPO_EMISSAO,
				@VERSAO_CHAVE_NFE	= @VERSAO_CHAVE_NFE,
				@CODIGO_UF_IBGE		= NULL

			SELECT @CHAVE_NFE = CHAVE FROM @CHAVE_NFE_T

			SET @STEP = 4
			--> Atualiza dados nas tabelas
			UPDATE #TMP_FATURAMENTO SET CHAVE_NFE = @CHAVE_NFE, NF_SAIDA = @NF_SAIDA, NF_FATURA = @NF_SAIDA, FATURA_NUMERO = @NF_SAIDA
			UPDATE #TMP_FATURAMENTO_ITEM SET NF_SAIDA = @NF_SAIDA
			UPDATE #TMP_FATURAMENTO_PROD SET NF_SAIDA = @NF_SAIDA

			SET @STEP = 5	
			BEGIN TRY
				BEGIN TRAN

				SET @STEP = 6
				--> Grava dados na tabela Faturamento*
				INSERT INTO
					DBO.FATURAMENTO
					(FILIAL, -- FILIAL EMISSORA
					NF_SAIDA, -- NUMERO DA NF
					SERIE_NF, -- SERIE DA NF
					NOME_CLIFOR, -- DESTINO
					CONDICAO_PGTO, -- 
					NATUREZA_SAIDA,
					TRANSPORTADORA,
					TRANSP_REDESPACHO,
					TIPO_FRETE,
					COD_TRANSACAO,
					EMISSAO,
					DATA_SAIDA,
					FRETE,
					SEGURO,
					DESCONTO,
					DESCONTO_COND_PGTO,
					ENCARGO,
					ICMS,
					IPI_VALOR,
					VALOR_TOTAL,
					QTDE_TOTAL,
					NF_FATURA,
					FATURA,
					NOTA_IMPRESSA,
					ACERTO_CONTAS_P_R,
					TABELA_FILHA,
					OBS,
					PESO_LIQUIDO,
					PESO_BRUTO,
					VOLUMES,
					TIPO_VOLUME,
					CONFERIDO,
					CONFERIDO_POR,
					ENTREGA_CIF,
					IRRF,
					IRRF_RET_FONTE,
					NOTA_CANCELADA,
					DEVOLUCAO,
					REPRESENTANTE,
					COMISSAO,
					PORCENTAGEM_ACERTO,
					GERENTE,
					COMISSAO_GERENTE,
					DESCONTO_BRUTO,
					ICMS_BASE,
					VALOR_CANCELADO,
					QTDE_CANCELADA,
					MOEDA,
					CAMBIO_NA_DATA,
					COBRAR_MOEDA_PADRAO,
					RECARGO,
					DATA_PARA_TRANSFERENCIA,
					NOME_CLIFOR_ENTREGA,
					VALOR_FRETE,
					OBS_TRANSPORTE,
					AGRUPAMENTO_ITENS,
					COMISSAO_VALOR,
					COMISSAO_VALOR_GERENTE,
					CTB_ITEM,
					CTB_LANCAMENTO,
					DESCONTO_BRUTO_1,
					DESCONTO_BRUTO_2,
					DESCONTO_BRUTO_3,
					DESCONTO_BRUTO_4,
					DESCONTO_SOBRE_1,
					DESCONTO_SOBRE_2,
					DESCONTO_SOBRE_3,
					DESCONTO_SOBRE_4,
					EMPRESA,
					FATURA_FILIAL,
					FATURA_NUMERO,
					FATURA_SERIE,
					ICMS_ISENTO,
					ICMS_OUTROS,
					MPADRAO_DESCONTO,
					MPADRAO_DESCONTO_COND_PGTO,
					MPADRAO_ENCARGO,
					MPADRAO_FRETE,
					MPADRAO_IMPOSTO_AGREGAR,
					MPADRAO_SEGURO,
					MPADRAO_VALOR_SUB_ITENS,
					MPADRAO_VALOR_TOTAL,
					MULTI_DESCONTO_ACUMULAR,
					PORC_DESCONTO,
					PORC_DESCONTO_BRUTO,
					PORC_DESCONTO_COND_PGTO,
					PORC_DESCONTO_DIGITADO,
					PORC_ENCARGO,
					RATEIO_CENTRO_CUSTO,
					RATEIO_FILIAL,
					VALOR_DIFERENCA_GUIA_FATURA,
					VALOR_IMPOSTO_AGREGAR,
					VALOR_SUB_ITENS,
					IMPRIMIR_ENDERECO_COBRANCA,
					INDICA_CONSUMIDOR_FINAL,
					NOTA_COMPLEMENTAR,
					PORC_DESCONTO_SEFAZ,
					DESCONTO_SEFAZ,
					MPADRAO_DESCONTO_SEFAZ,
					CHAVE_NFE,
					GERAR_AUTOMATICO,
					STATUS_NFE,
					LOG_STATUS_NFE,
					ITEM_NFE,
					PRIORIZACAO,
					REGISTRO_DPEC,
					DATA_REGISTRO_DPEC,
					TIPO_EMISSAO_NFE,
					FIN_EMISSAO_NFE,
					VALOR_DESPACHO,
					VALOR_IMPOSTO_INCIDENCIA,
					MPADRAO_VALOR_IMPOSTO_INCIDENCIA,
					DATA_HORA_EMISSAO,
					INDICA_PRESENCA_COMPRADOR,
					UTC_DATA_SAIDA,
					UTC_EMISSAO,
					INDICA_ENDERECO_ENTREGA,
					INFO_PGTO,
					DESC_MEIO_PGTO)
				SELECT * FROM #TMP_FATURAMENTO
	
				SET @STEP = 7
				INSERT INTO
					DBO.FATURAMENTO_PROD
					(FILIAL,
					NF_SAIDA,
					SERIE_NF,
					PRODUTO,
					COR_PRODUTO,
					ITEM,
					PEDIDO,
					PEDIDO_PRODUTO,
					PEDIDO_COR,
					ENTREGA,
					CAIXA,
					ROMANEIO,
					IPI,
					ICMS,
					DESCONTO_ITEM,
					QTDE,
					PRECO,
					VALOR,
					MATA_SALDO,
					F1,
					F2,
					F3,
					F4,
					F5,
					F6,
					F7,
					F8,
					F9,
					F10,
					F11,
					F12,
					F13,
					F14,
					F15,
					F16,
					F17,
					F18,
					F19,
					F20,
					F21,
					F22,
					F23,
					F24,
					F25,
					F26,
					F27,
					F28,
					F29,
					F30,
					F31,
					F32,
					F33,
					F34,
					F35,
					F36,
					F37,
					F38,
					F39,
					F40,
					F41,
					F42,
					F43,
					F44,
					F45,
					F46,
					F47,
					F48,
					FAIXA,
					ORIGEM,
					CUSTO_NA_DATA,
					MOEDA,
					CAMBIO_NA_DATA,
					ORIGEM_EMB,
					DATA_PARA_TRANSFERENCIA,
					CODIGO_LOCAL_ENTREGA,
					CODIGO_FISCAL_OPERACAO,
					COD_FILIAL_ESTOQUE,
					CUSTO_NA_DATA_2,
					CUSTO_NA_DATA_3,
					CUSTO_NA_DATA_4,
					ITEM_IMPRESSAO,
					ITEM_IMPRESSAO_FATURA,
					ITEM_PEDIDO,
					PRECO_2,
					PRECO_3,
					PRECO_4,
					VALOR_DIFERENCA_GUIA_FATURA_ITEM,
					DESC_VENDA_CLIENTE,
					LICENCIADO_ROYALTIES, TIMESTAMP)
				SELECT *,CONVERT(timestamp,GETDATE()) FROM #TMP_FATURAMENTO_PROD

				SET @STEP = 8
				INSERT 
					DBO.FATURAMENTO_ITEM
					(CLASSIF_FISCAL,
					CODIGO_FISCAL_OPERACAO,
					CODIGO_ITEM,
					COD_TABELA_FILHA,
					COMISSAO_ITEM,
					COMISSAO_ITEM_GERENTE,
					CONTA_CONTABIL,
					DESCONTO_ITEM,
					DESCRICAO_ITEM,
					FAIXA,
					FILIAL,
					ID_EXCECAO_IMPOSTO,
					INDICADOR_CFOP,
					ITEM_IMPRESSAO,
					MPADRAO_DESCONTO_ITEM,
					MPADRAO_PRECO_UNITARIO,
					MPADRAO_VALOR_ITEM,
					NF_SAIDA,
					PESO,
					PORCENTAGEM_ITEM_RATEIO,
					PRECO_UNITARIO,
					QTDE_DEVOLVIDA,
					QTDE_ITEM,
					QTDE_RETORNAR_BENEFICIAMENTO,
					SERIE_NF,
					SUB_ITEM_TAMANHO,
					TRIBUT_ICMS,
					TRIBUT_ORIGEM,
					UNIDADE,
					VALOR_ITEM,
					REFERENCIA,
					REFERENCIA_ITEM,
					MPADRAO_VALOR_DESCONTOS,
					MPADRAO_VALOR_ENCARGOS,
					NAO_SOMA_VALOR,
					ITEM_NFE,
					MPADRAO_SEGURO_ITEM,
					MPADRAO_FRETE_ITEM,
					MPADRAO_ENCARGO_ITEM,
					ORIGEM_ITEM,
					VALOR_IMPOSTO_ITEM,
					INDICA_PRODUTO_PROCESSO,
					PRECO_UNITARIO_ORIGINAL,
					VALOR_IMPOSTO_ITEM_MUNICIPAL,
					VALOR_IMPOSTO_ITEM_ESTADUAL )
				SELECT * FROM #TMP_FATURAMENTO_ITEM
			
				SET @STEP = 9
				--> Gera Impostos(Rever com o Nicolas regras fiscais)
				EXEC DBO.LX_GERA_IMPOSTOS_SAIDA @FILIAL_ESTOQUE,@NF_SAIDA, @WMS_FAT_SERIE, 1, 0, 1

				UPDATE TB_ECHO_WMS_CONTROLE
					SET DATA_HORA_UPDATE	= GETDATE(),
						APP_EXEC			= APP_NAME(),
						HOST				= HOST_NAME(),
						USUARIO				= SUSER_NAME(),
						TRANSF_NF			= @NF_SAIDA,
						TRANSF_SERIE		= @WMS_FAT_SERIE
				WHERE ID = @ID

				COMMIT TRAN

				IF @EXIBE_PRINT = 1  PRINT('SUCESSO')
			END TRY
			BEGIN CATCH
			
				DECLARE @ERRO_EXCEPTION VARCHAR(254)
				SET @ERRO_EXCEPTION = ERROR_MESSAGE()
			
				IF @EXIBE_PRINT = 1  PRINT('Erro Step: '+CONVERT(VARCHAR(2),@STEP)+' - '+@ERRO_EXCEPTION)

				ROLLBACK TRAN
			
				INSERT INTO
					DBO.TB_ECHO_WMS_CONTROLE_LOGS
					(ID,
					 ITEM,
					 ORIGEM,
					 DETALHES)
				SELECT
					 ID = @ID_CONTROLE,
					 ITEM = 1,
					 ORIGEM = 'SP_ECHO_WMS_GERA_TRANSFERENCIA',
					 DETALHES = 'Step: '+CONVERT(VARCHAR(2),@STEP)+' - '+@ERRO_EXCEPTION
		
				UPDATE TB_ECHO_WMS_CONTROLE
					SET	DATA_HORA_UPDATE	= GETDATE(),
						USUARIO				= SUSER_NAME(),
						HOST				= HOST_NAME(),
						APP_EXEC			= APP_NAME()
				WHERE ID = @ID_CONTROLE

			END CATCH
		END

		IF @RETORNA_STATUS = 1
		SELECT STATUS = @STATUS_CONCLUSAO,	MENSAGEM = @MSG_CONCLUSAO	

	END
	-- Se existir, Drop tabelas Temporarias
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO')			IS NOT NULL		DROP TABLE #TMP_FATURAMENTO
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO_PROD')	IS NOT NULL		DROP TABLE #TMP_FATURAMENTO_PROD
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO_ITEM')	IS NOT NULL		DROP TABLE #TMP_FATURAMENTO_ITEM
	IF OBJECT_ID('TempDB.dbo.#TMP_FATURAMENTO_IMPOSTO') IS NOT NULL		DROP TABLE #TMP_FATURAMENTO_IMPOSTO

END


