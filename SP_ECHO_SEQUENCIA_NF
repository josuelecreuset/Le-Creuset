CREATE OR ALTER PROCEDURE DBO.SP_ECHO_SEQUENCIA_NF (@SERIE_NF VARCHAR(10), @FILIAL VARCHAR(15), @NF_NUMERO VARCHAR(15) OUTPUT, @NF_NUMERO_ROLLBACK VARCHAR(15) = NULL)
AS
BEGIN
	
	IF @NF_NUMERO_ROLLBACK IS NULL
	BEGIN
		IF (SELECT SEQUENCIAL_POR_FILIAL FROM DBO.SERIES_NF WITH(NOLOCK) WHERE SERIE_NF = @SERIE_NF ) = 1
		BEGIN
		
			UPDATE FATURAMENTO_SEQUENCIAIS 
				SET SEQUENCIAL = RIGHT('000000000'+CONVERT(VARCHAR(15),SEQUENCIAL+1),9)
			WHERE FILIAL = @FILIAL AND SERIE_NF = @SERIE_NF

			SELECT @NF_NUMERO = SEQUENCIAL FROM FATURAMENTO_SEQUENCIAIS WHERE FILIAL = @FILIAL AND SERIE_NF = @SERIE_NF
		END
		ELSE
		BEGIN
		
			UPDATE SERIES_NF 
				SET SEQUENCIAL = RIGHT('000000000'+CONVERT(VARCHAR(15),SEQUENCIAL+1),9)
			WHERE SERIE_NF = @SERIE_NF

			SELECT @NF_NUMERO = SEQUENCIAL FROM SERIES_NF WHERE SERIE_NF = @SERIE_NF
		END
	END
	ELSE
	BEGIN
		IF (SELECT SEQUENCIAL_POR_FILIAL FROM DBO.SERIES_NF WITH(NOLOCK) WHERE SERIE_NF = @SERIE_NF ) = 1
		BEGIN
		
			UPDATE FATURAMENTO_SEQUENCIAIS 
				SET SEQUENCIAL = RIGHT('000000000'+CONVERT(VARCHAR(15),@NF_NUMERO_ROLLBACK),9)
			WHERE FILIAL = @FILIAL AND SERIE_NF = @SERIE_NF

			SELECT @NF_NUMERO = SEQUENCIAL FROM FATURAMENTO_SEQUENCIAIS WHERE FILIAL = @FILIAL AND SERIE_NF = @SERIE_NF
		END
		ELSE
		BEGIN
		
			UPDATE SERIES_NF 
				SET SEQUENCIAL = RIGHT('000000000'+CONVERT(VARCHAR(15),@NF_NUMERO_ROLLBACK),9)
			WHERE SERIE_NF = @SERIE_NF

			SELECT @NF_NUMERO = @NF_NUMERO_ROLLBACK
		END
	END

END
