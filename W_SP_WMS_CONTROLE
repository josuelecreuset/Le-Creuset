CREATE OR ALTER VIEW DBO.W_SP_WMS_CONTROLE
AS
SELECT
	SELECIONAR			= CONVERT(BIT,0),   
	ID					= B.ID,   
	FILIAL				= A.FILIAL,   
	CLIENTE				= A.NOME_CLIFOR,
	ORIGEM				= ISNULL(B.ORIGEM,'PEDIDO'), 
	TIPO				= C.TIPO,
	CHAVE				= A.PEDIDO,   
	ROMANEIO			= A.ROMANEIO,
	EMISSAO				= C.EMISSAO,
	NATUREZA			= C.NATUREZA_SAIDA,
	VALOR				= SUM(ISNULL(A.VALOR_EMBALADO,0.00)),
	QTDE				= SUM(ISNULL(A.QTDE_EMBALADA,0)),
	VOLUME				= 0,
	PESO				= SUM(ISNULL(P.PESO,0.000)*ISNULL(A.QTDE_EMBALADA,0)),
	S					= ISNULL(B.STATUS,0),   
	O					= ISNULL(B.STATUS_ANTERIOR,0),   
	DATA_HORA_GERACAO	= B.DATA_HORA_GERACAO,   
	DATA_HORA_UPDATE	= B.DATA_HORA_UPDATE,   
	USUARIO				= B.USUARIO,   
	HOST				= B.HOST,   
	APP_EXEC			= B.APP_EXEC,   
	SAIDA_NF			= B.SAIDA_NF,   
	SAIDA_SERIE			= B.SAIDA_SERIE,   
	TRANSF_NF			= B.TRANSF_NF,  
	TRANSF_SERIE		= B.TRANSF_SERIE,
	TIPO_FRETE			= RTRIM(LTRIM(C.TIPO_FRETE))+'-'+RTRIM(LTRIM(TF.DESCRICAO_TIPO)),
	TRANSPORTADORA		= C.TRANSPORTADORA,
	DATA_PICKING_ENVIO = CONVERT(DATETIME,NULL),
	DATA_PICKING_CONCLUIDO = CONVERT(DATETIME,NULL),
	DATA_FATURADO = CONVERT(DATETIME,NULL),
	DATA_DESPACHADO = CONVERT(DATETIME,NULL)
FROM DBO.VENDAS_PROD_EMBALADO A WITH(NOLOCK) 
JOIN DBO.VENDAS C WITH(NOLOCK)ON
	A.PEDIDO = C.PEDIDO
JOIN DBO.PRODUTOS P WITH(NOLOCK) ON
	A.PRODUTO = P.PRODUTO
LEFT JOIN DBO.TB_ECHO_WMS_CONTROLE B WITH(NOLOCK) ON
	A.FILIAL = B.FILIAL AND
	A.PEDIDO = B.CHAVE
LEFT JOIN DBO.TIPO_FRETE TF WITH(NOLOCK) ON
	C.TIPO_FRETE = TF.TIPO_FRETE
WHERE CAIXA_FECHADA = 1 AND B.ID IS NULL
GROUP BY 
	B.ID,   
	A.FILIAL,   
	A.NOME_CLIFOR,
	ISNULL(B.ORIGEM,'PEDIDO'), 
	C.TIPO,
	A.PEDIDO,   
	A.ROMANEIO,
	C.EMISSAO,
	C.NATUREZA_SAIDA,
	ISNULL(B.STATUS,0),   
	ISNULL(B.STATUS_ANTERIOR,0),   
	B.DATA_HORA_GERACAO,   
	B.DATA_HORA_UPDATE,   
	B.USUARIO,   
	B.HOST,   
	B.APP_EXEC,   
	B.SAIDA_NF,   
	B.SAIDA_SERIE,   
	B.TRANSF_NF,  
	B.TRANSF_SERIE,
	RTRIM(LTRIM(C.TIPO_FRETE))+'-'+RTRIM(LTRIM(TF.DESCRICAO_TIPO)),
	C.TRANSPORTADORA
UNION ALL
SELECT
	SELECIONAR			= CONVERT(BIT,0),   
	ID					= B.ID,   
	FILIAL				= B.FILIAL,   
	CLIENTE				= B.CLIENTE,
	ORIGEM				= ISNULL(B.ORIGEM,'PEDIDO'), 
	TIPO				= C.TIPO,
	CHAVE				= C.PEDIDO,   
	ROMANEIO			= C.ROMANEIO,
	EMISSAO				= C.EMISSAO,
	NATUREZA			= C.NATUREZA_SAIDA,
	VALOR				= SUM(ISNULL(ISNULL(A.VALOR_EMBALADO, FP.VALOR),0.00)),
	QTDE				= SUM(ISNULL(ISNULL(A.QTDE_EMBALADA, FP.QTDE),0)),
	VOLUME				= 0,
	PESO				= SUM(ISNULL(P.PESO,0.000)*ISNULL(ISNULL(A.QTDE_EMBALADA, FP.QTDE),0)),
	S					= ISNULL(B.STATUS,0),   
	O					= ISNULL(B.STATUS_ANTERIOR,0),   
	DATA_HORA_GERACAO	= B.DATA_HORA_GERACAO,   
	DATA_HORA_UPDATE	= B.DATA_HORA_UPDATE,   
	USUARIO				= B.USUARIO,   
	HOST				= B.HOST,   
	APP_EXEC			= B.APP_EXEC,   
	SAIDA_NF			= B.SAIDA_NF,   
	SAIDA_SERIE			= B.SAIDA_SERIE,   
	TRANSF_NF			= B.TRANSF_NF,  
	TRANSF_SERIE		= B.TRANSF_SERIE,
	TIPO_FRETE			= RTRIM(LTRIM(C.TIPO_FRETE))+'-'+RTRIM(LTRIM(TF.DESCRICAO_TIPO)),
	TRANSPORTADORA		= C.TRANSPORTADORA,
	B.DATA_PICKING_ENVIO,
	B.DATA_PICKING_CONCLUIDO,
	B.DATA_FATURADO,
	B.DATA_DESPACHADO
FROM DBO.TB_ECHO_WMS_CONTROLE B WITH(NOLOCK) 
JOIN DBO.VENDAS C WITH(NOLOCK)ON
	B.CHAVE = C.PEDIDO
LEFT JOIN DBO.VENDAS_PROD_EMBALADO A WITH(NOLOCK) ON
	C.PEDIDO = A.PEDIDO
LEFT JOIN DBO.FATURAMENTO_PROD FP WITH(NOLOCK) ON
	B.SAIDA_NF = FP.NF_SAIDA AND
	B.SAIDA_SERIE = FP.SERIE_NF AND
	B.FILIAL = FP.FILIAL
LEFT JOIN DBO.TIPO_FRETE TF WITH(NOLOCK) ON
	C.TIPO_FRETE = TF.TIPO_FRETE
JOIN DBO.PRODUTOS P WITH(NOLOCK) ON
	ISNULL(A.PRODUTO,FP.PRODUTO) = P.PRODUTO
GROUP BY 
	B.ID,   
	B.FILIAL,   
	B.CLIENTE,
	ISNULL(B.ORIGEM,'PEDIDO'), 
	C.TIPO,
	C.PEDIDO,   
	C.ROMANEIO,
	C.EMISSAO,
	C.NATUREZA_SAIDA,
	ISNULL(B.STATUS,0),   
	ISNULL(B.STATUS_ANTERIOR,0),   
	B.DATA_HORA_GERACAO,   
	B.DATA_HORA_UPDATE,   
	B.USUARIO,   
	B.HOST,   
	B.APP_EXEC,   
	B.SAIDA_NF,   
	B.SAIDA_SERIE,   
	B.TRANSF_NF,  
	B.TRANSF_SERIE,
	RTRIM(LTRIM(C.TIPO_FRETE))+'-'+RTRIM(LTRIM(TF.DESCRICAO_TIPO)),
	C.TRANSPORTADORA,
	B.DATA_PICKING_ENVIO,
	B.DATA_PICKING_CONCLUIDO,
	B.DATA_FATURADO,
	B.DATA_DESPACHADO
